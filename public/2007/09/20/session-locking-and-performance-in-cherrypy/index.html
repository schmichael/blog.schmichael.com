<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Session Locking and Performance in CherryPy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.15" />
  <link href="" rel="alternate" type="application/rss+xml" title="schmichael&#39;s blog" />
  <link href="https://blog.schmichael.com//css/bootstrap.min.css" rel="stylesheet">
  <link href="https://blog.schmichael.com//css/hc.css" rel="stylesheet">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  
    
    </head>
    <body>
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
      <div id = "wrapper">


<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="https://blog.schmichael.com//"><p class="navbar-brand">schmichael&#39;s blog</p></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
					
					<li><a href="https://blog.schmichael.com//about-me/">About </a></li>
					
					<li><a href="https://blog.schmichael.com//">Home </a></li>
					
					<li><a href="https://blog.schmichael.com//blog/">Blog </a></li>
					
          </ul>
        </div>
      </div>
    </div>



       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="" />
          <li class="sidebar-brand"><a href="https://blog.schmichael.com//"><h1 class="brand">schmichael&#39;s blog</h1></a><h3></h3></li>
          <hr />
					
						<li><a href="https://blog.schmichael.com//">Home </a></li>
					
						<li><a href="https://blog.schmichael.com//blog/">Blog </a></li>
					
						<li><a href="https://blog.schmichael.com//about-me/">About </a></li>
					
          <hr />
          <div id="social-wrapper">
           
           
           
           
         </div>
       </ul>
     </div>



     <div class="container">


  <div id="article">
   <div class="article-title">Session Locking and Performance in CherryPy</div>
   <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2007-09-20</small></p> <hr/>
   <div class="post">
     <p>While working on that firewall project <a href="http://michael.susens-schurter.com/blog/2007/09/18/a-lesson-on-python-dns-and-threads">I keep alluding to</a>, I came across an interesting caveat when using sessions (tools.sessions) and static file directories (tools.staticdir):</p>

<p>Sessions are locked on a per-request basis meaning while a request is being processed, all other requests <em>by that session</em> will <strong>block</strong> until the lock is released (by default at the end of the response handler).</p>

<p>This is a <strong>Very Good Thing</strong>, at least as the default behavior. Its the only safe way to automatically handle sessions.</p>

<p>However, this can become a performance problem, especially for those of us addicted to tabbed browsing. Take this trivial app as an example:</p>

<pre lang="python">#!/usr/bin/python
import cherrypy, time

class Test:
    @cherrypy.expose
    def page1(self):
        # Simulate long operation
        time.sleep(20)
        return "*Yawn*"

    @cherrypy.expose
    def page2(self):
        return "Hello World!"

cherrypy.config.update({
    'tools.sessions.on': True, 
    'tools.sessions.storage_type': 'ram'})
cherrypy.quickstart(Test(), '/')
</pre>

<p>Start it up, and then go to these pages in order in 2 different tabs:</p>

<ol>
<li><a href="http://localhost:8080/page1">http://localhost:8080/page1</a></li>
<li><a href="http://localhost:8080/page2">http://localhost:8080/page2</a></li>
</ol>

<p><strong>You&#8217;ll notice that page2 doesn&#8217;t load until page1 is finished loading!</strong> This effectively limits sessions to 1 request at a time. For many web sites this might not be an issue. However, for complex web applications which might be doing time consuming operations on the server, this could give users the impression the server has crashed.</p>

<p>Fortunately this is a very easy issue to resolve. The best way is to do <a href="http://cherrypy.org/wiki/CherryPySessions#Lockingsessions">explicit session locking manually.</a></p>

<p>However, if implicit session locking works for you most of the time you can sneak in a <code>cherrypy.session.release_lock()</code> into your code Like this:</p>

<pre lang="python">#...snip...
    @cherrypy.expose
    def page1(self):
        # Do any session manipulation here!
        cherrypy.session.release_lock()
        # Simulate long operation
        time.sleep(20)
        return "*Yawn*"
#...snip...
</pre>

<p>Now hit <a href="http://localhost:8080/page1">page1</a> and [2][4] again and notice that page2 loads immediately!</p>

<p><small>At <a href="http://technogeek.org/">Kevin&#8217;s</a> <a href="http://michael.susens-schurter.com/blog/2007/09/18/a-lesson-on-python-dns-and-threads/#comment-12731">suggestion</a> I turned off the visual editor in WordPress. I had thought of this before, but couldn&#8217;t find where the option to disable it was! Evidently its a per-user setting which makes sense.</p></p>

<p>
  At any rate, WordPress seems to be leaving my whitespace alone now! Thanks Kevin!</small>
</p>

<p>[4]: <a href="http://localhost:8080/page2">http://localhost:8080/page2</a></p>

   </div>
 </div>


 <a href="https://twitter.com/share" class="twitter-share-button " data-size="small" data-count="none">Tweet</a>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

 <ul class="pager">
      &nbsp;<li class="previous"><a href="https://blog.schmichael.com/2007/09/21/irc-after-a-10-year-hiatus/"> IRC After a 10 Year Hiatus</a></li>
      &nbsp;<li class="next"><a href="https://blog.schmichael.com/2007/09/18/a-lesson-on-python-dns-and-threads/"> A Lesson on Python, DNS, and Threads</a></li>
</ul>



    </ul>
    </div>
    <footer>

        <p class="text-muted credit">&copy; . All rights reserved. </p>
    </footer>
 
    <script src="/js/jquery-1.10.2.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootstrap.js"></script>
    <script type="text/javascript" src="/js/hc.js"></script>
</body>

</html>

